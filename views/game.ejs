<%- include('partials/header') %>

    <div class="container animate-pop">
        <div id="timerArea" class="timer-wrapper" style="display: none;">
            <span class="timer-icon">â³</span>
            <span id="timerDisplay" class="timer-count">0</span>
        </div>

        <div id="waitingScreen" class="loading-screen">
            <div class="pulse-loader"></div>
            <h3 class="primary-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø³Ø¤Ø§Ù„Ùƒ... â³</h3>
        </div>

        <div id="gameArea" class="fade-in-area" style="display: none;">
            <div id="roleDisplay" class="role-badge">âœ¨ Ø¬Ø§ÙˆØ¨ Ø¨ØµØ±Ø§Ø­Ø©</div>

            <div id="qContainer" class="question-container">
                <span class="question-label" id="qLabel">Ø³Ø¤Ø§Ù„Ùƒ:</span>
                <p id="questionDisplay" class="question-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <form id="answerForm" class="mt-20">
                <input type="text" id="answerInput" class="input-standard" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ..." required
                    autocomplete="off">
                <button type="submit" id="submitBtn" class="btn-primary">Ø¥Ø±Ø³Ø§Ù„ âš¡</button>
            </form>

            <div id="feedback" class="feedback-area" style="display: none;">
                <div class="success-icon">âœ…</div>
                <h3 class="success-text">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!</h3>
                <p class="secondary-text mt-10">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„ÙŠØ¬ÙŠØ¨ÙˆØ§ ğŸ•µï¸â€â™‚ï¸</p>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ Socket.io - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹!
        const socket = io();

        const waitingScreen = document.getElementById('waitingScreen');
        const gameArea = document.getElementById('gameArea');
        const questionDisplay = document.getElementById('questionDisplay');
        const qContainer = document.getElementById('qContainer');
        const qLabel = document.getElementById('qLabel');
        const roleDisplay = document.getElementById('roleDisplay');
        const answerForm = document.getElementById('answerForm');
        const answerInput = document.getElementById('answerInput');
        const feedback = document.getElementById('feedback');
        const timerArea = document.getElementById('timerArea');
        const timerDisplay = document.getElementById('timerDisplay');

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
        const playerName = "<%= playerName %>";
        let timerInterval;

        // Ø§Ù„Ø§ØªØµØ§Ù„ ÙŠØªÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„ÙƒÙˆÙƒÙŠØ²
        // socket.emit('join_game') -> ØªÙ…Øª Ø¥Ø²Ø§Ù„ØªÙ‡ Ù„Ø£Ù†Ù‡ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
        socket.on('connect_error', (err) => {
            if (err.message === 'Authentication error') {
                // Ù†Ø³ØªØ®Ø¯Ù… query param Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙƒÙŠØ²
                if (!window.location.search.includes('error=auth')) {
                    window.location.replace('/?error=auth');
                }
            }
        });

        socket.on('start_countdown', (endTime) => {
            if (!timerArea || !timerDisplay) return;
            clearInterval(timerInterval);
            timerArea.style.display = 'inline-flex';

            timerInterval = setInterval(() => {
                const timeLeft = Math.ceil((endTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.innerText = "0";
                    return;
                }
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 5) {
                    timerDisplay.classList.add('timer-low');
                } else {
                    timerDisplay.classList.remove('timer-low');
                }
            }, 1000);
        });

        function displayQuestion(question, role) {
            if (!question) return;
            waitingScreen.style.display = 'none';
            gameArea.style.display = 'block';
            questionDisplay.innerText = question;
            qContainer.className = "question-container";
            qLabel.innerText = "Ø³Ø¤Ø§Ù„Ùƒ:";
            roleDisplay.innerText = "âœ¨ Ø¬Ø§ÙˆØ¨ Ø¨ØµØ±Ø§Ø­Ø©";
        }

        const savedQuestion = sessionStorage.getItem('currentQuestion');
        const savedRole = sessionStorage.getItem('playerRole');
        if (savedQuestion) displayQuestion(savedQuestion, savedRole);

        socket.on('receive_question', (data) => {
            sessionStorage.setItem('currentQuestion', data.question);
            sessionStorage.setItem('playerRole', data.role);
            displayQuestion(data.question, data.role);
        });

        answerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const answer = answerInput.value.trim();

            if (answer && playerName) {
                socket.emit('submit_answer', { name: playerName, answer: answer });
                answerForm.style.display = 'none';
                qContainer.classList.add('faded');
                feedback.style.display = 'block';
            }
        });

        socket.on('reveal_all_answers', (data) => {
            clearInterval(timerInterval);
            sessionStorage.setItem('allAnswers', JSON.stringify(data.answers));
            window.location.href = '/results';
        });

        socket.on('back_to_lobby', () => {
            clearInterval(timerInterval);
            sessionStorage.clear();
            window.location.replace('/lobby');
        });

        socket.on('force_logout', () => {
            clearInterval(timerInterval);
            sessionStorage.clear();
            // Ø§Ù„ÙƒÙˆÙƒÙŠØ² ØªÙØ­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
            window.location.replace('/');
        });
    </script>

    <%- include('partials/footer') %>