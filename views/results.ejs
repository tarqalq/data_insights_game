<%- include('partials/header') %>

<div class="container container-wide animate-pop">
    <h2 class="main-title">ูุฑุญูุฉ ุงูุชุญููู ูุงูุชุตููุช ๐ต๏ธโโ๏ธ</h2>
    
    <div id="timerArea" class="timer-wrapper" style="display: none; justify-content: center; margin-bottom: 20px;">
        <span class="timer-icon">โณ</span>
        <span id="timerDisplay" class="timer-count">0</span>
    </div>

    <div id="roleAlertHeader" style="margin-bottom: 20px;"></div>

    <div id="roleHintArea" class="role-hint" style="display: none;"></div>

    <p id="instructionText" class="instruction-text">ุจุงูุชุธุงุฑ ูุดู ุงูุฅุฌุงุจุงุช ูู ุงูุขุฏูู...</p>

    <div id="answersGrid" class="results-grid"></div>

    <button id="submitVoteBtn" class="btn-primary btn-submit-vote" style="display: none;" onclick="submitFinalVote()">
        ุณูู ุฅุฌุงุจุงุชู ุงูููุงุฆูุฉ ๐ณ๏ธ
    </button>

    <div id="selectionFeedback" class="status-msg" style="display: none;">
        <p>โ ุชู ุชุณุฌูู ุฃุตูุงุชู! ุงูุชุธุฑ ูุดู ุงูุญูููุฉ.. ๐</p>
    </div>

    <div id="finalResultArea" class="spy-reveal-card" style="display: none;">
        <h3 class="spy-reveal-title">ูุดู ุงููุณุชูุฑ! ๐ต๏ธโโ๏ธ</h3>
        
        <div class="question-container" style="background-color: rgba(220, 38, 38, 0.8) !important; background-image: none !important; border: 2px solid #991b1b; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);">
            <span class="question-label" style="color: rgba(255, 255, 255, 0.9); font-weight: 900;">ุณุคุงู ุงูุฌูุงุณูุณ ูุงู:</span>
            <p id="spyQuestionTitle" class="question-text" style="color: #ffffff; font-weight: bold; text-shadow: none;"></p>
        </div>

        <div id="spyList" class="spy-items-container"></div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const answersGrid = document.getElementById('answersGrid');
    const submitVoteBtn = document.getElementById('submitVoteBtn');
    const selectionFeedback = document.getElementById('selectionFeedback');
    const finalResultArea = document.getElementById('finalResultArea');
    const spyList = document.getElementById('spyList');
    const roleHintArea = document.getElementById('roleHintArea');
    const roleAlertHeader = document.getElementById('roleAlertHeader');
    const instructionText = document.getElementById('instructionText');
    const timerArea = document.getElementById('timerArea');
    const timerDisplay = document.getElementById('timerDisplay');
    
    const playerName = localStorage.getItem('data_insights_name');
    const playerRole = sessionStorage.getItem('playerRole');

    let isVoted = false;
    let maxSpyCount = 1;
    let selectedPlayers = [];
    let timerInterval; 

    socket.on('connect', () => {
        if (playerName) {
            socket.emit('join_game', { name: playerName });
            socket.emit('request_current_state'); 
        } else {
            window.location.replace('/');
        }
    });

    socket.on('start_countdown', (endTime) => {
        if (!timerArea || !timerDisplay) return;
        clearInterval(timerInterval);
        timerArea.style.display = 'inline-flex';
        timerInterval = setInterval(() => {
            const timeLeft = Math.ceil((endTime - Date.now()) / 1000);
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerDisplay.innerText = "0";
                return;
            }
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 5) timerDisplay.classList.add('timer-low');
        }, 1000);
    });

    socket.on('reveal_spy_count_for_voting', (count) => {
        maxSpyCount = count;
    });

    socket.on('reveal_all_answers', (data) => {
        if (!data || !data.answers || data.answers.length === 0) return;
        renderAnswers(data.answers);
        roleHintArea.style.display = 'block';

        if (playerRole === 'special') {
            isVoted = true; 
            // ุชูุจูู ุงูุฌุงุณูุณ ุดูุงููุฉ 80% ูุน ุฅุฌุจุงุฑ ุงูููู
            roleAlertHeader.innerHTML = `
                <div style="background-color: rgba(220, 38, 38, 0.8) !important; color: #ffffff; padding: 18px; border-radius: 15px; font-weight: 900; text-align: center; font-size: 1.3rem; border: 2px solid #991b1b; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                    ๐จ ุฃูุช ุงูุฌุงุณูุณ! ุฑุงูุจ ุงูููุงุด ูุญุงูู ุงูุงูุฏูุงุฌ..
                </div>`;
            instructionText.style.display = "none";
            
            // ุณุคุงู ุงูุฌูููุฑ ููุฌุงุณูุณ ุดูุงููุฉ 80% ูุน ุฅุฌุจุงุฑ ุงูููู
            roleHintArea.innerHTML = `
                <div class="question-container" style="background-color: rgba(220, 38, 38, 0.8) !important; background-image: none !important; border: 2px solid #991b1b; box-shadow: 0 8px 20px rgba(0,0,0,0.2); margin-top:10px;">
                    <span class="question-label" style="color: rgba(255, 255, 255, 0.9); font-weight: 900;">ุณุคุงู ุงูุฌูููุฑ ุงูุฐู ุฃุฌุงุจูุง ุนููู:</span>
                    <p class="question-text" style="color: #ffffff; font-weight: bold; text-shadow: none;">${data.generalQuestion}</p>
                </div>`;
        } else {
            roleAlertHeader.innerHTML = "";
            instructionText.innerText = `ููุฌุฏ ${maxSpyCount} ุฌูุงุณูุณุ ุงุฎุชุฑ ${maxSpyCount} ุฅุฌุงุจุงุช ุชุดู ูููุง:`;
            roleHintArea.innerHTML = `
                <div class="question-container">
                    <span class="question-label">๐ ูููุฉ ุงูุจุญุซ ุนู ุณุคุงู ุงูุฌุงุณูุณ:</span>
                    <p class="question-text">${data.spyQuestion}</p>
                </div>`;
        }
    });

    function renderAnswers(answers) {
        answersGrid.innerHTML = '';
        const otherAnswers = answers.filter(item => item.name !== playerName);
        otherAnswers.forEach(item => {
            const card = document.createElement('div');
            card.className = 'answer-card';
            card.innerText = item.answer;
            card.setAttribute('data-player-name', item.name);
            card.onclick = () => { handleSelect(card, item.name); };
            if (playerRole === 'special') card.classList.add('card-disabled');
            answersGrid.appendChild(card);
        });
    }

    function handleSelect(card, targetPlayer) {
        if (isVoted || playerRole === 'special') return;
        if (selectedPlayers.includes(targetPlayer)) {
            selectedPlayers = selectedPlayers.filter(p => p !== targetPlayer);
            card.classList.remove('selected-card');
        } else {
            if (selectedPlayers.length < maxSpyCount) {
                selectedPlayers.push(targetPlayer);
                card.classList.add('selected-card');
            }
        }
        updateCardsUI();
        submitVoteBtn.style.display = selectedPlayers.length === maxSpyCount ? 'block' : 'none';
    }

    function updateCardsUI() {
        document.querySelectorAll('.answer-card').forEach(c => {
            const cName = c.getAttribute('data-player-name');
            if (selectedPlayers.length === maxSpyCount) {
                if (!selectedPlayers.includes(cName)) {
                    c.style.opacity = "0.4";
                    c.style.pointerEvents = "none"; 
                } else {
                    c.style.opacity = "1";
                    c.style.pointerEvents = "auto";
                }
            } else {
                c.style.opacity = "1";
                c.style.pointerEvents = "auto";
            }
        });
    }

    function submitFinalVote() {
        if (selectedPlayers.length !== maxSpyCount || isVoted) return;
        selectedPlayers.forEach(pName => {
            socket.emit('submit_vote', { voter: playerName, votedAnswer: pName });
        });
        isVoted = true;
        submitVoteBtn.style.display = 'none';
        selectionFeedback.style.display = 'block';
    }

    socket.on('final_spy_reveal', (data) => {
        clearInterval(timerInterval); 
        answersGrid.style.display = 'none';
        submitVoteBtn.style.display = 'none';
        selectionFeedback.style.display = 'none';
        roleHintArea.style.display = 'none';
        roleAlertHeader.style.display = 'none';
        instructionText.style.display = 'none';
        timerArea.style.display = 'none'; 
        
        finalResultArea.style.display = 'block';
        document.getElementById('spyQuestionTitle').innerText = data.spyQuestion;
        
        spyList.innerHTML = data.spies.map(spy => `
            <div class="spy-item-card">
                ๐ค ุงููุดุงุฑู: <strong>${spy.name}</strong> <br>
                ๐ฌ ุฅุฌุงุจุชู: <span class="spy-answer-text">"${spy.answer}"</span>
            </div>`).join('');
    });

    socket.on('back_to_lobby', () => {
        clearInterval(timerInterval);
        sessionStorage.clear();
        window.location.replace('/lobby');
    });

    socket.on('nav_to_leaderboard', () => {
        clearInterval(timerInterval);
        window.location.replace('/leaderboard');
    });

    socket.on('force_logout', () => {
        clearInterval(timerInterval);
        localStorage.removeItem('data_insights_name');
        sessionStorage.clear();
        window.location.replace('/');
    });
</script>

<style>
/* ูุถูุงู ุญุฏุฉ ุงููุต ุงูุฃุจูุถ */
.question-text {
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
}
</style>

<%- include('partials/footer') %>