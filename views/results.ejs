<%- include('partials/header') %>

    <div class="container container-wide animate-pop">
        <h2 class="main-title">Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØª ğŸ•µï¸â€â™‚ï¸</h2>

        <div id="timerArea" class="timer-wrapper" style="display: none; justify-content: center; margin-bottom: 20px;">
            <span class="timer-icon">â³</span>
            <span id="timerDisplay" class="timer-count">0</span>
        </div>

        <div id="roleAlertHeader" style="margin-bottom: 20px;"></div>

        <div id="roleHintArea" class="role-hint" style="display: none;"></div>

        <p id="instructionText" class="instruction-text">Ø§Ù†ØªØ¸Ø± ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</p>

        <div id="answersGrid" class="results-grid"></div>

        <button id="submitVoteBtn" class="btn-primary btn-submit-vote" style="display: none;"
            onclick="submitFinalVote()">
            ØµÙˆÙ‘Øª Ø§Ù„Ø¢Ù† ğŸ—³ï¸
        </button>

        <div id="selectionFeedback" class="status-msg" style="display: none;">
            <p>âœ… ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª! Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©...</p>
        </div>

        <div id="finalResultArea" class="spy-reveal-card" style="display: none;">
            <h3 class="spy-reveal-title">Ø§Ù„Ù†ØªÙŠØ¬Ø©! ğŸ•µï¸â€â™‚ï¸</h3>

            <div class="question-container spy-reveal-box">
                <span class="question-label">Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³:</span>
                <p id="spyQuestionTitle" class="question-text"></p>
            </div>

            <div id="spyList" class="spy-items-container"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const answersGrid = document.getElementById('answersGrid');
        const submitVoteBtn = document.getElementById('submitVoteBtn');
        const selectionFeedback = document.getElementById('selectionFeedback');
        const finalResultArea = document.getElementById('finalResultArea');
        const spyList = document.getElementById('spyList');
        const roleHintArea = document.getElementById('roleHintArea');
        const roleAlertHeader = document.getElementById('roleAlertHeader');
        const instructionText = document.getElementById('instructionText');
        const timerArea = document.getElementById('timerArea');
        const timerDisplay = document.getElementById('timerDisplay');

        // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± Ø§Ù„Ù€ cookies
        const playerName = "<%= playerName %>";
        const playerRole = sessionStorage.getItem('playerRole');

        let isVoted = false;
        let maxSpyCount = 1;
        let selectedPlayers = [];
        let timerInterval;

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ - Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ØªØªÙ… Ø¹Ø¨Ø± Ø§Ù„Ù€ cookies
        socket.on('connect_error', (err) => {
            if (err.message === 'Authentication error') {
                if (!window.location.search.includes('error=auth')) {
                    window.location.replace('/?error=auth');
                }
            }
        });

        socket.on('start_countdown', (endTime) => {
            if (!timerArea || !timerDisplay) return;
            clearInterval(timerInterval);
            timerArea.style.display = 'inline-flex';
            timerInterval = setInterval(() => {
                const timeLeft = Math.ceil((endTime - Date.now()) / 1000);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.innerText = "0";
                    return;
                }
                timerDisplay.innerText = timeLeft;
                if (timeLeft <= 5) timerDisplay.classList.add('timer-low');
            }, 1000);
        });

        socket.on('reveal_spy_count_for_voting', (count) => {
            maxSpyCount = count;
        });

        socket.on('reveal_all_answers', (data) => {
            if (!data || !data.answers || data.answers.length === 0) return;
            renderAnswers(data.answers);
            roleHintArea.style.display = 'block';

            if (playerRole === 'special') {
                isVoted = true;
                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ Ø´ÙØ§ÙÙŠØ© 80% Ù…Ø¹ Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù„ÙˆÙ†
                roleAlertHeader.innerHTML = `
                <div class="spy-role-alert">
                    <div class="spy-icon-large">ğŸ•µï¸â€â™‚ï¸</div>
                    <div>
                        <div class="spy-title-text">Ø£Ù†Øª Ø§Ù„Ø¬Ø§Ø³ÙˆØ³!</div>
                        <div class="spy-subtitle-text">Ø§Ù†Ø¯Ù…Ø¬ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† ÙˆÙ„Ø§ ØªÙƒØ´Ù Ù†ÙØ³Ùƒ</div>
                    </div>
                </div>`;
                instructionText.display = "none";

                // Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù„Ù„Ø¬Ø§Ø³ÙˆØ³
                roleHintArea.innerHTML = `
                <div class="question-container spy-theme-box-modern">
                    <span class="question-label">Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ± Ù‡Ùˆ:</span>
                    <p class="question-text">${data.generalQuestion}</p>
                </div>`;
            } else {
                roleAlertHeader.innerHTML = "";
                instructionText.innerText = `Ø§Ø®ØªØ± ${maxSpyCount} Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø´Ø¨ÙˆÙ‡Ø©:`;
                roleHintArea.innerHTML = `
                <div class="question-container">
                    <span class="question-label">ğŸ” Ù…Ù‡Ù…Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³:</span>
                    <p class="question-text">${data.spyQuestion}</p>
                </div>`;
            }
        });

        function renderAnswers(answers) {
            answersGrid.innerHTML = '';
            const otherAnswers = answers.filter(item => item.name !== playerName);
            otherAnswers.forEach(item => {
                const card = document.createElement('div');
                card.className = 'answer-card';
                card.innerText = item.answer;
                card.setAttribute('data-player-name', item.name);
                card.onclick = () => { handleSelect(card, item.name); };
                if (playerRole === 'special') card.classList.add('card-disabled');
                answersGrid.appendChild(card);
            });
        }

        function handleSelect(card, targetPlayer) {
            if (isVoted || playerRole === 'special') return;
            if (selectedPlayers.includes(targetPlayer)) {
                selectedPlayers = selectedPlayers.filter(p => p !== targetPlayer);
                card.classList.remove('selected-card');
            } else {
                if (selectedPlayers.length < maxSpyCount) {
                    selectedPlayers.push(targetPlayer);
                    card.classList.add('selected-card');
                }
            }
            updateCardsUI();
            submitVoteBtn.style.display = selectedPlayers.length === maxSpyCount ? 'block' : 'none';
        }

        function updateCardsUI() {
            document.querySelectorAll('.answer-card').forEach(c => {
                const cName = c.getAttribute('data-player-name');
                if (selectedPlayers.length === maxSpyCount) {
                    if (!selectedPlayers.includes(cName)) {
                        c.style.opacity = "0.4";
                        c.style.pointerEvents = "none";
                    } else {
                        c.style.opacity = "1";
                        c.style.pointerEvents = "auto";
                    }
                } else {
                    c.style.opacity = "1";
                    c.style.pointerEvents = "auto";
                }
            });
        }

        function submitFinalVote() {
            if (selectedPlayers.length !== maxSpyCount || isVoted) return;
            selectedPlayers.forEach(pName => {
                socket.emit('submit_vote', { voter: playerName, votedAnswer: pName });
            });
            isVoted = true;
            submitVoteBtn.style.display = 'none';
            selectionFeedback.style.display = 'block';
        }

        socket.on('final_spy_reveal', (data) => {
            clearInterval(timerInterval);
            answersGrid.style.display = 'none';
            submitVoteBtn.style.display = 'none';
            selectionFeedback.style.display = 'none';
            roleHintArea.style.display = 'none';
            roleAlertHeader.style.display = 'none';
            instructionText.style.display = 'none';
            timerArea.style.display = 'none';

            finalResultArea.style.display = 'block';
            document.getElementById('spyQuestionTitle').innerText = data.spyQuestion;

            const totalVotes = data.totalVotes || 0;
            spyList.innerHTML = data.spies.map(spy => `
            <div class="spy-item-card" style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center;">
                
                <div style="background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 12px; margin-bottom: 10px; display: inline-block;">
                    ğŸ‘¤ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³: <strong style="color: #ef4444; font-size: 1.1rem;">${spy.name}</strong>
                </div>
                
                <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                    <span style="background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 15px; font-size: 0.9rem;">
                        ğŸ—³ï¸ Ø£ØµÙˆØ§Øª Ø¶Ø¯Ù‡: <strong>${spy.votes} / ${totalVotes}</strong>
                    </span>
                    <span style="background: rgba(255,255,255,0.1); color: #fff; padding: 6px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold;">
                        ğŸ’ ÙƒØ³Ø¨: <strong>${spy.earned || 0}</strong>
                    </span>
                </div>

                <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 12px; font-size: 1rem; color: #e5e7eb; margin-top: 5px;">
                    ğŸ’¬ Ø¥Ø¬Ø§Ø¨ØªÙ‡: 
                    <div class="spy-answer-text" style="color: #fff; font-weight: bold; margin-top: 5px; font-size: 1.1rem;">"${spy.answer}"</div>
                </div>

            </div>`).join('');
        });

        socket.on('back_to_lobby', () => {
            clearInterval(timerInterval);
            sessionStorage.clear();
            window.location.replace('/lobby');
        });

        socket.on('nav_to_leaderboard', () => {
            clearInterval(timerInterval);
            window.location.replace('/leaderboard');
        });

        socket.on('force_logout', () => {
            clearInterval(timerInterval);
            localStorage.removeItem('data_insights_name');
            sessionStorage.clear();
            window.location.replace('/');
        });
    </script>

    <style>
        /* Ù„Ø¶Ù…Ø§Ù† Ø­Ø¯Ø© Ø§Ù„Ù†Øµ Ø§Ù„Ø£Ø¨ÙŠØ¶ */
        .question-text {
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
    </style>

    <%- include('partials/footer') %>