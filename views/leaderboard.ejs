<%- include('partials/header') %>

    <div class="leaderboard-page-wrapper">
        <div class="leaderboard-container">
            <h1 class="leaderboard-main-title">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h1>

            <div id="leaderboardList" class="leaderboard-list-wrapper"></div>

            <div class="footer-msg warning-box" style="margin-top: 20px;">
                â³ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©...
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const listDiv = document.getElementById('leaderboardList');
        // Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¹Ø¨Ø± Ø§Ù„Ù€ cookies
        const playerName = "<%= playerName %>";

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        socket.on('connect_error', (err) => {
            if (err.message === 'Authentication error') {
                if (!window.location.search.includes('error=auth')) {
                    window.location.replace('/?error=auth');
                }
            }
        });

        // Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù†Ø§Ø¬Ø­
        socket.on('connect', () => {
            console.log('Connected to server, requesting leaderboard...');
            socket.emit('request_leaderboard');
        });

        socket.on('update_leaderboard', (data) => {
            const scores = data.scores || {};
            const times = data.times || {};

            const sorted = Object.entries(scores).sort((a, b) => {
                if (b[1] !== a[1]) return b[1] - a[1];
                return (times[a[0]] || 0) - (times[b[0]] || 0);
            });

            if (sorted.length === 0) {
                listDiv.innerHTML = '<div class="empty-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</div>';
                return;
            }

            listDiv.innerHTML = sorted.map(([name, score], index) => {
                const isMe = name === playerName;
                const highlightStyle = isMe ? 'border: 2px solid var(--accent-green); background: rgba(34, 197, 94, 0.15);' : '';
                const meBadge = isMe ? '<span style="font-size: 0.8rem; color: var(--text-gold); margin-right: 5px;">(Ø£Ù†Øª)</span>' : '';

                return `
                <div class="leaderboard-row" style="animation-delay: ${index * 0.05}s; ${highlightStyle}">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="player-name">${name} ${meBadge}</div>
                    <div class="points-badge">${score} Ù†Ù‚Ø·Ø©</div>
                </div>
            `;
            }).join('');
        });

        socket.on('back_to_lobby', () => {
            sessionStorage.clear();
            window.location.replace('/lobby');
        });

        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ receive_question Ù‡Ù†Ø§ - Ù†Ø­Ù† ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†

        socket.on('nav_to_lobby', () => {
            window.location.replace('/lobby');
        });

        socket.on('force_logout', () => {
            sessionStorage.clear();
            window.location.replace('/');
        });
    </script>

    <%- include('partials/footer') %>