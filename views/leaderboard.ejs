<%- include('partials/header') %>

<div class="leaderboard-page-wrapper">
    <div class="leaderboard-container">
        <h1 class="leaderboard-main-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ğŸ†</h1>
        
        <div id="leaderboardList" class="leaderboard-list-wrapper">
            </div>

        <div class="footer-msg warning-box" style="border-style: solid; margin-top: 20px;">
            Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ù†Ø¸Ù…... â³
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const listDiv = document.getElementById('leaderboardList');
    const playerName = localStorage.getItem('data_insights_name');

    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
    if (playerName) {
        socket.emit('join_game', { name: playerName });
    }

    // Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙˆØ± Ø¯Ø®ÙˆÙ„ Ø§Ù„ØµÙØ­Ø©
    socket.emit('request_leaderboard');

    socket.on('update_leaderboard', (data) => {
        const scores = data.scores || {};
        const times = data.times || {};

        // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ù‚Ø§Ø·Ø§Ù‹ Ø«Ù… Ø§Ù„Ø£Ø³Ø±Ø¹ ÙˆÙ‚ØªØ§Ù‹
        const sorted = Object.entries(scores).sort((a, b) => {
            if (b[1] !== a[1]) return b[1] - a[1];
            return (times[a[0]] || 0) - (times[b[0]] || 0);
        });

        if (sorted.length === 0) {
            listDiv.innerHTML = '<div class="empty-results">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†..</div>';
            return;
        }

        listDiv.innerHTML = sorted.map(([name, score], index) => {
            // ØªÙ…ÙŠÙŠØ² Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const isMe = name === playerName;
            const highlightStyle = isMe ? 'border: 2px solid var(--accent-green); background: rgba(16, 185, 129, 0.15);' : '';
            const meBadge = isMe ? '<span style="font-size: 0.8rem; color: var(--text-gold); margin-right: 5px;">(Ø£Ù†Øª)</span>' : '';

            return `
                <div class="leaderboard-row" style="animation-delay: ${index * 0.05}s; ${highlightStyle}">
                    <div class="rank-num">#${index + 1}</div>
                    <div class="player-name">${name} ${meBadge}</div>
                    <div class="points-badge">${score} Ù†Ù‚Ø·Ø©</div>
                </div>
            `;
        }).join('');
    });

    // --- Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ØªØ¯ÙÙ‚ Ø§Ù„Ù„Ø¹Ø¨Ø© ---

    // 1. Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¨ÙŠ (Ø¹Ù†Ø¯ ØªØµÙÙŠØ± Ø§Ù„Ø¬ÙˆÙ„Ø©)
    socket.on('back_to_lobby', () => {
        sessionStorage.clear();
        window.location.replace('/lobby');
    });

    // 2. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø³Ù‡ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†)
    socket.on('receive_question', (data) => {
        sessionStorage.setItem('currentQuestion', data.question);
        sessionStorage.setItem('playerRole', data.role);
        window.location.replace('/game');
    });

    // 3. Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆØ¨ÙŠ (Ø¥Ø´Ø§Ø±Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ØªØ£ÙƒÙŠØ¯)
    socket.on('nav_to_lobby', () => {
        window.location.replace('/lobby');
    });

    // 4. Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù‚Ø³Ø±ÙŠ
    socket.on('force_logout', () => {
        localStorage.removeItem('data_insights_name');
        sessionStorage.clear();
        window.location.replace('/');
    });
</script>

<%- include('partials/footer') %>