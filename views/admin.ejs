<%- include('partials/header') %>

    <div class="container container-wide animate-pop">
        <h1 class="main-title">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¢Ø¯Ù…Ù† ğŸ‘‘</h1>

        <div id="adminTimerArea" class="timer-wrapper"
            style="display: none; justify-content: center; margin-bottom: 20px;">
            <span class="timer-icon">â³</span>
            <span id="adminTimerDisplay" class="timer-count">0</span>
        </div>

        <div class="stats-card-main">
            <p class="stats-label">Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ø¢Ù†:</p>
            <div class="counter-glow-wrapper-admin">
                <span id="countDisplay" class="counter-number-admin">0</span>
            </div>
        </div>

        <div id="roundSelectorContainer" class="round-card">
            <p class="section-subtitle">Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:</p>
            <div id="roundGrid" class="round-grid-modern">
            </div>
        </div>

        <div id="adminProgress" class="warning-box"
            style="display: none; border-style: solid; background: rgba(16, 185, 129, 0.1); border-color: var(--accent-green);">
            <p id="progressLabel" class="progress-text" style="margin:0; font-weight: bold; font-size: 1.2rem;">
                Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: <span id="adminAnswersCount" class="counter-number-admin"
                    style="font-size: 2rem;">0</span>
                <span id="totalVs" style="display:none;"> / <span id="expectedCount">0</span></span>
            </p>
        </div>

        <div class="admin-section" style="margin-top: 30px;">
            <h4 class="section-subtitle">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±:</h4>
            <div class="player-labels-container" id="playerList">
                <p class="empty-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†...</p>
            </div>
        </div>

        <div class="divider"></div>

        <div class="admin-controls-flex">
            <button id="startBtn" class="btn-primary">
                Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© ğŸš€
            </button>

            <button id="revealBtn" class="btn-primary btn-action-blue" style="display: none;">
                ÙƒØ´Ù Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ù„ØªØµÙˆÙŠØª ğŸ§
            </button>

            <button id="showSpiesBtn" class="btn-primary btn-action-purple" style="display: none;">
                ÙƒØ´Ù Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ ğŸ”¥
            </button>

            <button id="goLeaderboardBtn" class="btn-primary btn-action-orange" style="display: none;">
                Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† (Ø¹Ù†Ø¯ Ø§Ù„ÙƒÙ„) ğŸ†
            </button>

            <button id="nextRoundBtn" class="btn-primary btn-action-dark" style="display: none;">
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ¨ÙŠ (Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©) ğŸ”„
            </button>

            <button id="cancelRoundBtn" class="btn-primary btn-action-dark"
                style="background: rgba(239, 68, 68, 0.2); border-color: #ef4444; color: #ef4444;">
                Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± â†©ï¸
            </button>
        </div>

        <button onclick="handleFullReset()" class="btn-danger-minimal"
            style="margin-top: 40px; background: none; border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 10px; border-radius: 10px; cursor: pointer; width: 100%;">
            Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø¬Ù„Ø³Ø© (Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ğŸš¨
        </button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let selectedRoundIndex = null;
        let timerInterval;

        const countDisplay = document.getElementById('countDisplay');
        const playerListDiv = document.getElementById('playerList');
        const startBtn = document.getElementById('startBtn');
        const revealBtn = document.getElementById('revealBtn');
        const showSpiesBtn = document.getElementById('showSpiesBtn');
        const goLeaderboardBtn = document.getElementById('goLeaderboardBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const cancelRoundBtn = document.getElementById('cancelRoundBtn');
        const adminProgress = document.getElementById('adminProgress');
        const adminAnswersCount = document.getElementById('adminAnswersCount');
        const progressLabel = document.getElementById('progressLabel');
        const roundGrid = document.getElementById('roundGrid');
        const roundSelectorContainer = document.getElementById('roundSelectorContainer');
        const expectedCount = document.getElementById('expectedCount');
        const totalVs = document.getElementById('totalVs');
        const adminTimerArea = document.getElementById('adminTimerArea');
        const adminTimerDisplay = document.getElementById('adminTimerDisplay');

        // Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
        for (let i = 0; i < 10; i++) {
            const btn = document.createElement('button');
            btn.innerText = i + 1;
            btn.className = "round-btn-modern";
            btn.onclick = () => {
                document.querySelectorAll('.round-btn-modern').forEach(b => b.classList.remove('active-round'));
                btn.classList.add('active-round');
                selectedRoundIndex = i;
            };
            roundGrid.appendChild(btn);
        }

        // Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ø¨Ù†Ø¸Ø§Ù… ÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯
        socket.on('start_countdown', (endTime) => {
            if (!adminTimerArea || !adminTimerDisplay) return;

            clearInterval(timerInterval);
            adminTimerArea.style.display = 'inline-flex';

            timerInterval = setInterval(() => {
                const timeLeft = Math.ceil((endTime - Date.now()) / 1000);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    adminTimerDisplay.innerText = "0";
                    return;
                }

                adminTimerDisplay.innerText = timeLeft;
                if (timeLeft <= 5) adminTimerDisplay.classList.add('timer-low');
                else adminTimerDisplay.classList.remove('timer-low');
            }, 1000);
        });

        socket.on('update_player_count', (count) => {
            countDisplay.innerText = count;
        });

        socket.on('update_player_list', (players) => {
            if (!playerListDiv) return;
            playerListDiv.innerHTML = players.length === 0 ?
                '<p class="empty-msg">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†...</p>' :
                players.map(p => `<span class="player-label-tag">ğŸ‘¤ ${p.name}</span>`).join('');
        });

        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø­Ø°ÙÙ†Ø§ Ù…Ø³ØªÙ‚Ø¨Ù„ nav_to_leaderboard Ù…Ù† Ù‡Ù†Ø§ Ù„ÙƒÙŠ Ù„Ø§ ØªÙ†ØªÙ‚Ù„ ØµÙØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù†

        startBtn.addEventListener('click', () => {
            if (selectedRoundIndex === null) {
                Swal.fire({
                    icon: 'warning',
                    title: 'ØªÙ†Ø¨ÙŠÙ‡',
                    text: 'ÙØ¶Ù„Ø§Ù‹ Ø§Ø®ØªØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹!',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            const currentCount = parseInt(countDisplay.innerText);
            if (currentCount < 1) {
                Swal.fire({
                    icon: 'error',
                    title: 'Ø®Ø·Ø£',
                    text: 'ÙŠØ¬Ø¨ ÙˆØ¬ÙˆØ¯ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                    confirmButtonColor: '#d33'
                });
                return;
            }

            socket.emit('admin_start_game', { roundIndex: selectedRoundIndex });

            startBtn.style.display = 'none';
            roundSelectorContainer.style.display = 'none';
            adminProgress.style.display = 'block';
            cancelRoundBtn.style.display = 'block';
            progressLabel.firstChild.textContent = "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©: ";
            totalVs.style.display = 'none';
            revealBtn.style.display = 'block';
        });

        socket.on('answer_received_count', (count) => {
            adminAnswersCount.innerText = count;
        });

        revealBtn.addEventListener('click', () => {
            socket.emit('admin_reveal_answers');
            revealBtn.style.display = 'none';
            progressLabel.firstChild.textContent = "Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØµÙˆØªÙŠÙ†: ";
            totalVs.style.display = 'inline';

            const currentTotal = parseInt(countDisplay.innerText);
            let spyCount = Math.floor((currentTotal - 1) / 10) + 1;
            const expectedVoters = currentTotal - spyCount;
            expectedCount.innerText = expectedVoters;

            showSpiesBtn.style.display = 'block';
        });

        showSpiesBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… ÙƒØ´Ù Ø§Ù„Ø¬ÙˆØ§Ø³ÙŠØ³ ÙˆØ¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬!",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#8e44ad',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§ÙƒØ´Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('admin_show_spies');
                    showSpiesBtn.style.display = 'none';
                    goLeaderboardBtn.style.display = 'block';
                    clearInterval(timerInterval);
                    adminTimerArea.style.display = 'none';
                }
            });
        });

        // ÙŠØ±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„ÙŠØ­ÙˆÙ„ "Ø§Ù„ÙƒÙ„" Ù…Ø§ Ø¹Ø¯Ø§ ØµÙØ­Ø© Ø§Ù„Ø¢Ø¯Ù…Ù† Ù„Ø£Ù†Ù‡Ø§ Ù„Ø§ ØªÙ…Ù„Ùƒ Ù…Ø³ØªÙ‚Ø¨Ù„ nav_to_leaderboard
        goLeaderboardBtn.addEventListener('click', () => {
            socket.emit('admin_go_to_leaderboard');
            goLeaderboardBtn.style.display = 'none';
            nextRoundBtn.style.display = 'block'; // ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„Ù„Ø¢Ø¯Ù…Ù† ÙÙˆØ±Ø§Ù‹
        });

        const resetUI = () => {
            startBtn.style.display = 'block';
            roundSelectorContainer.style.display = 'block';
            adminProgress.style.display = 'none';
            revealBtn.style.display = 'none';
            showSpiesBtn.style.display = 'none';
            goLeaderboardBtn.style.display = 'none';
            nextRoundBtn.style.display = 'none';
            clearInterval(timerInterval);
            adminTimerArea.style.display = 'none';
            totalVs.style.display = 'none';
            selectedRoundIndex = null;
            document.querySelectorAll('.round-btn-modern').forEach(b => b.classList.remove('active-round'));
            adminAnswersCount.innerText = "0";
        };

        nextRoundBtn.addEventListener('click', () => {
            socket.emit('admin_next_round');
            resetUI();
        });

        cancelRoundBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: "Ø³ÙŠØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ† Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ÙˆØ¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø£Ù„ØºÙ Ø§Ù„Ø¬ÙˆÙ„Ø©',
                cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('admin_next_round');
                    resetUI();
                    Swal.fire(
                        'ØªÙ… Ø§Ù„Ø§Ù„ØºØ§Ø¡!',
                        'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±.',
                        'success'
                    )
                }
            });
        });

        function handleFullReset() {
            Swal.fire({
                title: 'Ù…Ø³Ø­ Ø´Ø§Ù…Ù„ ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸš¨',
                text: "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ·Ø±Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†!",
                icon: 'error',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡!',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((result) => {
                if (result.isConfirmed) {
                    socket.emit('admin_full_reset_db');
                    setTimeout(() => location.reload(), 2000); // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙˆÙ‚Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ø±Ø¤ÙŠØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø¥Ù† ÙˆØ¬Ø¯Øª
                    Swal.fire(
                        'ØªÙ… Ø§Ù„Ù…Ø³Ø­!',
                        'ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­.',
                        'success'
                    )
                }
            });
        }
    </script>

    <%- include('partials/footer') %>