<%- include('partials/header') %>

<div class="container">
    <h2 class="main-title">ุฑุคู ุงูุจูุงูุงุช</h2>
    <p class="sub-title-text">Data Insights Community</p>

    <hr class="divider">

    <div id="joinCard" class="card animate-pop">
        <h3>ูุฑุญุจุงู ุจู ูู ุงููุนุงููุฉ! ๐</h3>
        <p>ูุถูุงู ุงุฏุฎู ุงุณูู ููุงูุถูุงู ุฅูู ุงููุนุจุฉ ุงูุชูุงุนููุฉ</p>

        <form id="joinForm" class="mt-20">
            <input type="text" id="playerName" 
                   class="input-standard"
                   placeholder="ุงูุชุจ ุงุณูู ุงูุญูููู ููุง..." 
                   required 
                   autocomplete="off">
            
            <button type="submit" id="joinBtn" class="btn-primary">
                ุงูุถู ุงูุขู ๐
            </button>
        </form>

        <div id="statusMessage" class="status-msg" style="display: none;">
            ุฌุงุฑู ุชุฃููู ุงุชุตุงูู ูุญูุธ ุจูุงูุงุชู...
        </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const joinForm = document.getElementById('joinForm');
    const playerNameInput = document.getElementById('playerName');
    const statusMessage = document.getElementById('statusMessage');
    const joinBtn = document.getElementById('joinBtn');

    if (localStorage.getItem('data_insights_name')) {
        window.location.replace('/lobby');
    }

    playerNameInput.focus();

    joinForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = playerNameInput.value.trim();
        
        if (name) {
            joinBtn.disabled = true;
            joinBtn.innerText = 'ุฌุงุฑู ุงูุชุญูู...';
            statusMessage.style.display = 'block';
            statusMessage.innerText = 'ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ...';

            const timeout = setTimeout(() => {
                if (joinBtn.disabled) {
                    alert('ูุจุฏู ุฃู ููุงู ุจุทุก ูู ุงูุงุชุตุงูุ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                    resetUI();
                }
            }, 5000);

            socket.emit('join_game', { name: name }, (response) => {
                clearTimeout(timeout); 

                if (response && response.status === 'ok') {
                    localStorage.setItem('data_insights_name', name);
                    statusMessage.innerText = 'ุชู ุชุณุฌููู ุจูุฌุงุญ! ุฌุงุฑู ุงูุฏุฎูู...';
                    window.location.replace('/lobby');
                } else if (response && response.status === 'taken') {
                    alert(response.message);
                    resetUI();
                } else {
                    alert('ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุชููู ุบูุฑ ูุชููุน.');
                    resetUI();
                }
            });
        }
    });

    function resetUI() {
        joinBtn.disabled = false;
        joinBtn.innerText = 'ุงูุถู ุงูุขู ๐';
        statusMessage.style.display = 'none';
        playerNameInput.focus();
    }

    socket.on('force_logout', () => {
        localStorage.removeItem('data_insights_name');
        sessionStorage.clear();
        window.location.replace('/');
    });
</script>

<%- include('partials/footer') %>